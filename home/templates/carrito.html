{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carrito de Compras - Todo Jardín</title>
  <link rel="stylesheet" href="{% static 'styles/main.css' %}">
  <link rel="stylesheet" href="{% static 'styles/carrito.css' %}">
</head>
<body>
  <!-- Top Navigation Bar -->
  <nav class="topbar">
    <div class="topbar-container">
      <div class="logo">
        <a href="{% url 'mainPage' %}">
          <img src="{% static 'images/Logo.png' %}" alt="Todo Jardín Logo">
        </a>
        <h1><a href="{% url 'mainPage' %}">Todo Jardín</a></h1>
      </div>
      <div class="nav-links">
        <a href="{% url 'productos' %}">Productos</a>
        <a href="{% url 'terminos' %}">Términos y Condiciones</a>
      </div>
      <!-- Buscador en navegación -->
      <div class="search-bar-nav">
        <form method="GET" action="{% url 'productos' %}" class="search-form-nav">
          <input type="text" name="buscar" placeholder="Buscar productos..." class="search-input-nav" value="">
          <button type="submit" class="search-btn-nav">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>
        </form>
      </div>
      <div class="user-circle">
        <a href="{% url 'user' %}" class="user-link">
          <div class="circle">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3
              1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08
              6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            </svg>
          </div>
        </a>
      </div>
    </div>
  </nav>

  <main class="carrito-container">
    <h1>Carrito de Compras</h1>

    {% if items %}
      <div class="carrito-content">
        <div class="items-list">
          {% for item_data in items %}
            <div class="carrito-item">
              <div class="item-imagen">
                {% if item_data.item.producto.imagen_principal %}
                  <img src="{{ item_data.item.producto.imagen_principal.imagen.url }}" alt="{{ item_data.item.producto.nombre }}">
                {% else %}
                  <img src="https://via.placeholder.com/150x150/4a7c2c/ffffff?text=Sin+Imagen" alt="{{ item_data.item.producto.nombre }}">
                {% endif %}
              </div>

              <div class="item-info">
                <h3>{{ item_data.item.producto.nombre }}</h3>
                <p class="item-precio">€{{ item_data.precio_unitario }}</p>
              </div>

              <div class="item-cantidad">
                <form method="POST" action="{% url 'actualizar_cantidad_carrito' item_data.item.id %}" style="display: flex; align-items: center; gap: 0.8rem;">
                  {% csrf_token %}
                  <button type="submit" name="cantidad" value="{{ item_data.item.cantidad|add:'-1' }}" class="btn-cantidad">−</button>
                  <span class="cantidad-display">{{ item_data.item.cantidad }}</span>
                  <button type="submit" name="cantidad" value="{{ item_data.item.cantidad|add:'1' }}" class="btn-cantidad">+</button>
                </form>
              </div>

              <div class="item-total">
                <p>€{{ item_data.total }}</p>
              </div>

              <div class="item-eliminar">
                <a href="{% url 'eliminar_del_carrito' item_data.item.id %}" class="btn-eliminar">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </a>
              </div>
            </div>
          {% endfor %}
        </div>

        <div class="carrito-resumen">
          <h2>Resumen del Pedido</h2>

          <div class="resumen-linea">
            <span>Subtotal:</span>
            <span class="total-valor">€{{ subtotal }}</span>
          </div>

          <div class="resumen-linea">
            <span>IVA (21%):</span>
            <span>€{{ iva }}</span>
          </div>

          <div class="resumen-linea envio-info">
            <span>Envío:</span>
            <span>
              {% if coste_envio == 0 %}
                GRATIS
              {% else %}
                €{{ coste_envio }}
              {% endif %}
            </span>
          </div>

          {% if subtotal < config.envio_minimo_gratis %}
            <p class="envio-info">Envío gratis en pedidos superiores a {{ config.envio_minimo_gratis }}€</p>
          {% endif %}

          <hr>

          <div class="resumen-linea total">
            <span>Total:</span>
            <span class="total-valor">€{{ total }}</span>
          </div>

          <a href="{% url 'checkout' %}" class="btn-checkout">Proceder al Pago</a>
          <a href="{% url 'productos' %}" class="btn-continuar">Continuar Comprando</a>
        </div>
      </div>
    {% else %}
      <div class="carrito-vacio">
        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"
             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
             aria-hidden="true">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        <h2>Tu carrito está vacío</h2>
        <p>¡Agrega productos para comenzar tu compra!</p>
        <a href="{% url 'productos' %}" class="btn-productos">Ver Productos</a>
      </div>
    {% endif %}
  </main>

  <script>
    // CSRF cookie helper (Django)
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function actualizarCantidadBtn(btn, cambio) {
      const itemId = btn.getAttribute('data-item-id');
      const cantidadActual = parseInt(btn.getAttribute('data-cantidad'));
      const nuevaCantidad = cantidadActual + cambio;
      actualizarCantidad(itemId, nuevaCantidad);
    }

    function eliminarItemBtn(btn) {
      const itemId = btn.getAttribute('data-item-id');
      eliminarItem(itemId);
    }

    function actualizarCantidad(itemId, nuevaCantidad) {
      if (nuevaCantidad < 0) return; // evita negativos
      const csrftoken = getCookie('csrftoken');

      fetch(`/carrito/actualizar/${itemId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken
        },
        body: `cantidad=${encodeURIComponent(nuevaCantidad)}`
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert(data.error || 'No se pudo actualizar la cantidad.');
        }
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Hubo un error al actualizar el carrito');
      });
    }

    function eliminarItem(itemId) {
      if (!confirm('¿Estás seguro de eliminar este producto?')) return;

      const csrftoken = getCookie('csrftoken');

      fetch(`/carrito/eliminar/${itemId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken }
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert(data.error || 'No se pudo eliminar el producto.');
        }
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Hubo un error al eliminar el producto');
      });
    }
  </script>
</body>
</html>
