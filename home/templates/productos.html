{% load static %}

<!DOCTYPE html>

<html lang="es">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Productos - Todo Jardin</title>

    <link rel="stylesheet" href="{% static 'styles/main.css' %}">

    <link rel="stylesheet" href="{% static 'styles/productos.css' %}">

</head>

<body>

    <!-- Top Navigation Bar -->

    <nav class="topbar">

        <div class="topbar-container">

            <div class="logo">

                <a href="{% url 'mainPage' %}">
                    <img src="{% static 'images/Logo.png' %}" alt="Todo Jardin Logo">
                </a>

                <h1><a href="{% url 'mainPage' %}">Todo Jardin</a></h1>

            </div>

            <div class="nav-links">


                <a href="{% url 'productos' %}" class="active">Productos</a>

                <a href="{% url 'terminos' %}">T√©rminos y Condiciones</a>

                {% if user_is_admin %}
                <a href="{% url 'admin_panel' %}" class="admin-link">Panel Admin</a>
                {% endif %}

            </div>

            <!-- Buscador en navegaci√≥n -->
            <div class="search-bar-nav">
                <form method="GET" action="{% url 'productos' %}" class="search-form-nav">
                    <input type="text" name="buscar" placeholder="Buscar productos..." class="search-input-nav" value="{{ buscar }}">
                    <button type="submit" class="search-btn-nav">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </button>
                </form>
            </div>

            <div class="nav-icons">
                <div class="carrito-container">
                    <a href="{% url 'carrito' %}" class="carrito-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                        {% if cart_info.cantidad_total > 0 %}
                        <span class="carrito-badge">{{ cart_info.cantidad_total }}</span>
                        {% endif %}
                    </a>
                    
                    <!-- Mini Carrito Dropdown -->
                    {% if cart_info.tiene_items %}
                    <div class="mini-carrito">
                        <div class="mini-carrito-header">
                            <h3>Mi Carrito</h3>
                            <span class="mini-carrito-count">{{ cart_info.cantidad_total }} art√≠culo{% if cart_info.cantidad_total != 1 %}s{% endif %}</span>
                        </div>
                        <div class="mini-carrito-items">
                            {% for item_data in cart_info.items %}
                            <div class="mini-carrito-item">
                                {% if item_data.item.producto.imagen_principal %}
                                <img src="{{ item_data.item.producto.imagen_principal.imagen.url }}" alt="{{ item_data.item.producto.nombre }}">
                                {% else %}
                                <img src="https://via.placeholder.com/60x60/4a7c2c/ffffff?text=Sin+Imagen" alt="{{ item_data.item.producto.nombre }}">
                                {% endif %}
                                <div class="mini-item-info">
                                    <p class="mini-item-nombre">{{ item_data.item.producto.nombre }}</p>
                                    <p class="mini-item-cantidad">{{ item_data.item.cantidad }} x {{ item_data.precio_unitario }}‚Ç¨</p>
                                </div>
                                <p class="mini-item-total">{{ item_data.total }}‚Ç¨</p>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mini-carrito-footer">
                            <div class="mini-carrito-subtotal">
                                <span>Subtotal:</span>
                                <span class="subtotal-precio">{{ cart_info.subtotal }}‚Ç¨</span>
                            </div>
                            <div class="mini-carrito-acciones">
                                <a href="{% url 'carrito' %}" class="btn-ver-carrito">Ver Carrito</a>
                                <a href="{% url 'checkout' %}" class="btn-checkout">Finalizar Compra</a>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="mini-carrito mini-carrito-vacio">
                        <p>Tu carrito est√° vac√≠o</p>
                        <a href="{% url 'productos' %}" class="btn-ver-productos">Ver Productos</a>
                    </div>
                    {% endif %}
                </div>

                <div class="user-circle">

                <a href="{% url 'user' %}" class="user-link">

                    <div class="circle">

                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">

                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>

                        </svg>

                    </div>

                </a>

            </div>

        </div>

    </nav>

    <!-- Main Content -->

    <div class="productos-page">

        <div class="page-header">
            <div class="header-content">
                <div>
                    <h1>Nuestros Productos</h1>
                    <p>Descubre nuestra amplia selecci√≥n de plantas y accesorios para jardiner√≠a</p>
                </div>
                {% if user_is_admin %}
                <a href="{% url 'admin_crear_producto' %}" class="btn-crear-producto">
                     Crear Nuevo Producto
                </a>
                {% endif %}
            </div>
        </div>

        <div class="productos-container">

            <!-- Sidebar con filtros -->
            <aside class="filtros-sidebar">
                <h2>Filtros</h2>

                <form method="GET" action="{% url 'productos' %}" id="filtros-form">
                    <!-- Mantener valor de b√∫squeda si existe -->
                    {% if buscar %}
                    <input type="hidden" name="buscar" value="{{ buscar }}">
                    {% endif %}

                    <!-- Categor√≠as -->
                    <div class="filtro-section">
                        <h3>Categor√≠as</h3>
                        <div class="checkbox-list">
                            {% for cat in categorias %}
                            <label class="checkbox-item">
                                <input type="checkbox" name="categoria" value="{{ cat.id }}" 
                                       {% if cat.id in categorias_ids_seleccionadas %}checked{% endif %}
                                       onchange="document.getElementById('filtros-form').submit()">
                                <span>{{ cat.nombre }} ({{ cat.productos.count }})</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Marcas -->
                    <div class="filtro-section">
                        <h3>Marcas</h3>
                        <div class="checkbox-list">
                            {% for marca in marcas %}
                            <label class="checkbox-item">
                                <input type="checkbox" name="marca" value="{{ marca.id }}"
                                       {% if marca.id in marcas_ids_seleccionadas %}checked{% endif %}
                                       onchange="document.getElementById('filtros-form').submit()">
                                <span>{{ marca.nombre }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Rango de Precio -->
                    <div class="filtro-section">
                        <h3>Precio</h3>
                        <div class="precio-slider-container">
                            <div class="precio-valores">
                                <span id="precio-min-label">‚Ç¨{{ precio_min|default:precio_minimo_db }}</span>
                                <span id="precio-max-label">‚Ç¨{{ precio_max|default:precio_maximo_db }}</span>
                            </div>
                            <div class="slider-wrapper">
                                <div class="slider-track"></div>
                                <div class="slider-range" id="slider-range"></div>
                                <input type="range" id="precio-min-slider" name="precio_min" 
                                       min="{{ precio_minimo_db }}" max="{{ precio_maximo_db }}" 
                                       value="{{ precio_min|default:precio_minimo_db }}" step="0.01">
                                <input type="range" id="precio-max-slider" name="precio_max" 
                                       min="{{ precio_minimo_db }}" max="{{ precio_maximo_db }}" 
                                       value="{{ precio_max|default:precio_maximo_db }}" step="0.01">
                            </div>
                            <button type="button" class="btn-aplicar-precio" onclick="aplicarFiltroPrecio()">Aplicar</button>
                        </div>
                    </div>

                    <!-- Mantener el orden seleccionado -->
                    <input type="hidden" name="orden" value="{{ orden }}">
                </form>

                <a href="{% url 'productos' %}" class="btn-limpiar">Limpiar Filtros</a>

            </aside>

            <!-- Grid de productos -->
            <div class="productos-content">

                <div class="productos-header">
                    <div class="header-left">
                        <p class="resultado-count">{{ productos|length }} productos encontrados</p>
                        
                        <!-- Mostrar filtros activos -->
                        {% if categorias_seleccionadas or marcas_seleccionadas or buscar or precio_min or precio_max %}
                        <div class="filtros-activos">
                            <span class="filtros-label">Filtros activos:</span>
                            
                            {% if buscar %}
                            <span class="filtro-tag">
                                B√∫squeda: "{{ buscar }}"
                            </span>
                            {% endif %}
                            
                            {% for cat in categorias_seleccionadas %}
                            <span class="filtro-tag">
                                {{ cat.nombre }}
                            </span>
                            {% endfor %}
                            
                            {% for marca in marcas_seleccionadas %}
                            <span class="filtro-tag">
                                {{ marca.nombre }}
                            </span>
                            {% endfor %}
                            
                            {% if precio_min or precio_max %}
                            <span class="filtro-tag">
                                Precio: ‚Ç¨{{ precio_min|default:precio_minimo_db }} - ‚Ç¨{{ precio_max|default:precio_maximo_db }}
                            </span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="ordenar">
                        <label for="orden">Ordenar por:</label>
                        <select id="orden" onchange="cambiarOrden(this.value)">
                            <option value="nombre" {% if orden == 'nombre' %}selected{% endif %}>Nombre</option>
                            <option value="precio-asc" {% if orden == 'precio-asc' %}selected{% endif %}>Precio: Menor a Mayor</option>
                            <option value="precio-desc" {% if orden == 'precio-desc' %}selected{% endif %}>Precio: Mayor a Menor</option>
                            <option value="destacados" {% if orden == 'destacados' %}selected{% endif %}>Destacados</option>
                        </select>
                    </div>
                </div>

                {% if productos %}
                <div class="productos-grid">
                    {% for producto in productos %}
                    <div class="producto-card">
                        {% if producto.stock == 0 %}
                        <div class="badge-agotado">AGOTADO</div>
                        {% endif %}
                        {% if producto.es_destacado %}
                        <div class="badge-destacado">‚≠ê DESTACADO</div>
                        {% endif %}

                        <div class="producto-imagen">
                            {% if producto.imagen_principal %}
                            <img src="{{ producto.imagen_principal.imagen.url }}" 
                                 alt="{{ producto.nombre }}">
                            {% else %}
                            <img src="https://via.placeholder.com/300x300/4a7c2c/ffffff?text={{ producto.nombre }}" 
                                 alt="{{ producto.nombre }}">
                            {% endif %}
                        </div>

                        <div class="producto-info">
                            <h3>{{ producto.nombre }}</h3>
                            <p class="producto-descripcion">{{ producto.descripcion|truncatewords:15 }}</p>
                            
                            {% if producto.marca %}
                            <p class="producto-marca">{{ producto.marca.nombre }}</p>
                            {% endif %}

                            {% if producto.categoria %}
                            <span class="producto-categoria">{{ producto.categoria.nombre }}</span>
                            {% endif %}

                            <div class="producto-precios">
                                <span class="precio">‚Ç¨{{ producto.precio }}</span>
                            </div>

                            <div class="producto-stock">
                                {% if producto.stock > 0 %}
                                <span class="stock-disponible">‚úì En stock ({{ producto.stock }})</span>
                                {% else %}
                                <span class="stock-agotado">Agotado</span>
                                {% endif %}
                            </div>

                            <div class="producto-acciones">
                                {% if producto.stock > 0 %}
                                <a href="{% url 'checkout_rapido' producto.id %}" class="btn-compra-rapida">
                                    üöÄ Compra R√°pida
                                </a>
                                <div>
                                    <a href="{% url 'agregar_al_carrito' producto.id %}" class="btn-agregar-carrito">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="9" cy="21" r="1"></circle>
                                            <circle cx="20" cy="21" r="1"></circle>
                                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                        </svg>
                                        A√±adir
                                    </a>
                                    <a href="{% url 'producto_detalle' producto.id %}" class="btn-ver-detalle">Ver Detalles</a>
                                </div>
                                {% else %}
                                <a href="{% url 'producto_detalle' producto.id %}" class="btn-ver-detalle">Ver Detalles</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-productos">
                    <p>No se encontraron productos con los filtros seleccionados.</p>
                    <a href="{% url 'productos' %}" class="btn-volver">Ver todos los productos</a>
                </div>
                {% endif %}

            </div>

        </div>

    </div>

    <script>
        function cambiarOrden(orden) {
            // Crear URL manualmente sin los par√°metros de precio
            const url = new URL(window.location.href);
            const params = new URLSearchParams(url.search);
            
            // Mantener solo categor√≠a, marca, b√∫squeda y orden
            const newParams = new URLSearchParams();
            
            // Mantener b√∫squeda
            if (params.has('buscar')) {
                newParams.set('buscar', params.get('buscar'));
            }
            
            // Mantener categor√≠as
            params.getAll('categoria').forEach(cat => {
                newParams.append('categoria', cat);
            });
            
            // Mantener marcas
            params.getAll('marca').forEach(marca => {
                newParams.append('marca', marca);
            });
            
            // Mantener precio solo si no es el rango por defecto
            const currentMinPrice = params.get('precio_min');
            const currentMaxPrice = params.get('precio_max');
            
            if (currentMinPrice && parseFloat(currentMinPrice) !== minPrice) {
                newParams.set('precio_min', currentMinPrice);
            }
            
            if (currentMaxPrice && parseFloat(currentMaxPrice) !== maxPrice) {
                newParams.set('precio_max', currentMaxPrice);
            }
            
            // A√±adir nuevo orden
            newParams.set('orden', orden);
            
            // Redirigir con los nuevos par√°metros (sin precio_min/precio_max)
            window.location.href = '{% url "productos" %}?' + newParams.toString();
        }

        // Configurar sliders de precio
        const precioMinSlider = document.getElementById('precio-min-slider');
        const precioMaxSlider = document.getElementById('precio-max-slider');
        const precioMinLabel = document.getElementById('precio-min-label');
        const precioMaxLabel = document.getElementById('precio-max-label');
        const sliderRange = document.getElementById('slider-range');

        const minPrice = parseFloat(precioMinSlider.min);
        const maxPrice = parseFloat(precioMinSlider.max);

        function actualizarLabels() {
            let minVal = parseFloat(precioMinSlider.value);
            let maxVal = parseFloat(precioMaxSlider.value);

            // Asegurar que min no sea mayor que max
            if (minVal > maxVal) {
                // Intercambiar valores
                const temp = maxVal;
                maxVal = minVal;
                minVal = temp;
                precioMinSlider.value = minVal;
                precioMaxSlider.value = maxVal;
            }

            precioMinLabel.textContent = '‚Ç¨' + minVal.toFixed(2);
            precioMaxLabel.textContent = '‚Ç¨' + maxVal.toFixed(2);

            // Actualizar barra de progreso visual
            const percentMin = ((minVal - minPrice) / (maxPrice - minPrice)) * 100;
            const percentMax = ((maxVal - minPrice) / (maxPrice - minPrice)) * 100;
            sliderRange.style.left = percentMin + '%';
            sliderRange.style.width = (percentMax - percentMin) + '%';
        }

        precioMinSlider.addEventListener('input', actualizarLabels);
        precioMaxSlider.addEventListener('input', actualizarLabels);

        function aplicarFiltroPrecio() {
            document.getElementById('filtros-form').submit();
        }

        // Inicializar labels al cargar
        actualizarLabels();
    </script>

</body>

</html>
